<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>不延时学生列表</title>
    <link href="http://cdn.staticfile.net/bootstrap/5.3.2/css/bootstrap.css" rel="stylesheet">
    <script src="http://cdn.staticfile.net/bootstrap/5.3.2/js/bootstrap.bundle.js"></script>
<!--    <script src="https://cdn.jsdelivr.net/npm/browser-ips@1.0.0/dist/index.min.js"></script>-->
</head>
<body>

    <div style="width: 100%" class="row">
      <div style="position: fixed;height: 100%;overflow-y: scroll;" class="col-4" data-bs-spy="scroll" >
        <div id="list-example" class="list-group scrollspy-example" >
            {% if grades %}
                {% for grade in grades %}
                <a style="font-size: calc(1rem + 1.2vw);" class="list-group-item list-group-item-action" href="#grade{{grade.id}}">{{grade.class_text}}</a>
                {% endfor %}
            {% endif %}
        </div>
      </div>
      <div style="margin-left: auto" class="col-8">
        <div data-bs-spy="scroll" data-bs-target="#list-example" data-bs-smooth-scroll="true" class="scrollspy-example" tabindex="0">
            <br>
            {% for i in grades %}
            <div  id="grade{{i.id}}">
                {% for student in students %}
                    {% if student.class_text_id == i.id %}
                    <div>
                        <div style="display: block">
                        <h1 style="font-size: calc(2rem + 1.2vw);display: inline-block;">{{student.student_text}}</h1>
                        <p style="font-size: calc(1rem + 1.2vw);display: inline-block;float: right">{{student.class_text}}</p>
                        </div>
                        {% if student.info_text != None %}
                        <p style="font-size: calc(0.6rem + 1.2vw);">备注：{{student.info_text}}</p>
                        {% endif %}
                        <div style="padding-left: 0;" class="form-check">
                            <label style="margin-top: 1.3em;float: left" class="form-check-label" for="flexSwitchCheckDefault">勾选表示已离校</label>
                            <input style="width: 5.6em;height: 2.6em;float: right;border: var(--bs-border-width) solid #86b7fe;border-radius: 2rem;" class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault" data-student-id="{{student.id}}">
                        </div>
                        <br>
                        <hr>
                        <br>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
        </div>
      </div>
    </div>

<!--  <script>-->

<!--    // 获取所有的复选框-->
<!--    const checkboxes = document.querySelectorAll('.form-check-input');-->
<!--    checkboxes.forEach(checkbox => {-->
<!--      checkbox.addEventListener('change', function () {-->
<!--        const studentId = this.dataset.studentId;  // 获取学生ID-->
<!--        const isChecked = this.checked;-->
<!--        const currentTime = new Date().toISOString();  // 获取当前时间，格式化为ISO字符串便于后端处理-->
<!--        //const ipAddress = window.location.hostname; // 获取本地主机名（可能近似内网IP-->

<!--        if (isChecked) {-->
<!--          // 当复选框被勾选后，阻止取消勾选操作-->
<!--          this.addEventListener('click', function (e) {-->
<!--            e.preventDefault();-->
<!--          });-->
<!--          // 使用fetch发送AJAX请求到后端，这里假设你的后端有个记录勾选信息的接口叫'/record_check'-->
<!--          fetch('record_check', {-->
<!--            method: 'POST',-->
<!--            headers: {-->
<!--              'Content-Type': 'application/json',-->
<!--            },-->
<!--            body: JSON.stringify({-->
<!--              studentId: studentId,-->
<!--              checkTime: currentTime,-->
<!--            })-->
<!--          })-->
<!--         .then(response => response.json())-->
<!--         .then(data => {-->
<!--            console.log(data);  // 可以根据后端返回的数据进行相应处理，这里先简单打印-->
<!--          })-->
<!--         .catch(error => {-->
<!--            console.error('Error:', error);-->
<!--          });-->
<!--        }-->
<!--      });-->
<!--    });-->
<!--  </script>-->
<script>
    // 页面加载完成后执行，先检查并设置各学生勾选框初始状态
    window.onload = function () {
        // 获取所有的复选框
        const checkboxes = document.querySelectorAll('.form-check-input');
        // 遍历每个复选框
        checkboxes.forEach(checkbox => {
            const studentName = checkbox.parentNode.previousElementSibling.querySelector('h1').textContent;
            const studentNameEncoded = encodeURIComponent(studentName);
            // 发送AJAX请求到后端检查该学生今天是否已勾选
            fetch('check_student_checked_today/' + studentNameEncoded + '/')
               .then(response => response.json())
               .then(data => {
                    if (data.checked) {
                        checkbox.checked = true;
                    }
                })
               .catch(error => {
                    console.error('Error fetching check status:', error);
                });

            checkbox.addEventListener('change', function () {
                const studentId = this.dataset.studentId;
                const isChecked = this.checked;
                const currentTime = new Date().toISOString();

                if (isChecked) {
                    this.addEventListener('click', function (e) {
                        e.preventDefault();
                    });
                    fetch('record_check', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            studentId: studentId,
                            checkTime: currentTime,
                        })
                    })
                  .then(response => response.json())
                  .then(data => {
                        console.log(data);
                    })
                  .catch(error => {
                        console.error('Error:', error);
                    });
                }
            });
        });
    };
</script>
</body>
</html>